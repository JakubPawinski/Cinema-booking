<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
  <title>Reservation Details - Cinema Booking</title>
  <style>
    /* Cinematic screen projection effect */
    .screen {
      background: linear-gradient(to bottom, #9333ea, transparent);
      opacity: 0.2;
      transform: perspective(600px) rotateX(-20deg) scale(0.9);
      box-shadow: 0 50px 40px rgba(147, 51, 234, 0.2);
      filter: blur(2px);
    }
    /* Seat base styling */
    .seat {
      width: 32px;
      height: 32px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      font-size: 10px;
      transition: all 0.3s ease;
    }
    /* Seat status variants */
    .seat.available { background-color: #1a1a1a; color: #4b5563; border: 1px solid #374151; }
    .seat.occupied { background-color: #450a0a; color: #991b1b; opacity: 0.4; pointer-events: none; }
    .seat.mine {
      background-color: #9333ea;
      color: white;
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.6);
      font-weight: 800;
      z-index: 10;
      transform: scale(1.15);
      border: 2px solid white;
    }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
  </style>
</head>
<body>

<div layout:fragment="content">
  <div class="container mx-auto px-6 py-12">

    <!-- Success Feedback Overlay -->
    <div id="success-alert" class="hidden mb-12 bg-green-500/10 border border-green-500/50 text-green-100 px-8 py-5 rounded-2xl flex items-center shadow-2xl backdrop-blur-md animate-slide-in">
      <div class="bg-green-500 p-3 rounded-full mr-5 shadow-lg shadow-green-900/40">
        <i class="fas fa-check text-xl text-white"></i>
      </div>
      <div>
        <h3 class="font-bold text-lg text-white">Payment Successful!</h3>
        <p class="text-sm text-green-400">Your seats are confirmed. You can now download your digital tickets below.</p>
      </div>
      <button onclick="this.parentElement.remove()" class="ml-auto text-green-500 hover:text-white transition">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Navigation Breadcrumb -->
    <a href="/profile" class="inline-flex items-center text-gray-500 hover:text-cinema-accent mb-10 transition-all font-bold uppercase text-xs tracking-widest no-underline">
      <i class="fas fa-chevron-left mr-2"></i> Back to Profile
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

      <!-- Left Panel: Summary & Tickets -->
      <div class="lg:col-span-1 space-y-8">

        <!-- Reservation Metadata Card -->
        <div class="bg-cinema-dark p-8 rounded-3xl border border-white/5 shadow-2xl relative overflow-hidden">
          <div class="absolute top-0 right-0 p-4 opacity-5">
            <i class="fas fa-receipt text-6xl"></i>
          </div>

          <div th:if="${reservation.reservationCode != null}" class="mb-8 text-center bg-black/40 p-5 rounded-2xl border border-dashed border-white/10">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Unique Booking ID</p>
            <p class="text-2xl font-mono text-cinema-accent font-black tracking-tighter" th:text="${reservation.reservationCode}">CODE</p>
          </div>

          <div class="flex justify-between items-end mb-6">
            <h2 class="text-2xl font-bold text-white font-serif">Details</h2>
            <span class="font-mono text-gray-600 text-[10px] tracking-widest uppercase">System Ref: #<span th:text="${reservation.id}">123</span></span>
          </div>

          <div class="space-y-4 text-sm">
            <div class="flex flex-col">
              <span class="text-gray-500 text-[10px] uppercase font-bold tracking-widest mb-1">Date & Time</span>
              <span class="text-white text-lg font-medium" th:if="${!reservation.tickets.empty}"
                    th:text="${#temporals.format(reservation.tickets[0].seance.startTime, 'EEEE, MMM dd â€¢ HH:mm')}">Date</span>
            </div>

            <div class="flex flex-col">
              <span class="text-gray-500 text-[10px] uppercase font-bold tracking-widest mb-1">Movie Title</span>
              <span class="text-cinema-gold text-xl font-bold font-serif" th:if="${!reservation.tickets.empty}"
                    th:text="${reservation.tickets[0].seance.movie.title}">Film</span>
            </div>

            <div class="flex justify-between items-center py-4 border-y border-white/5">
              <span class="text-gray-500 text-[10px] uppercase font-bold tracking-widest">Status</span>
              <span th:if="${reservation.status.name() == 'PAID'}" class="px-3 py-1 bg-green-500/10 text-green-400 text-[10px] font-black rounded-full border border-green-500/20 uppercase tracking-widest">Confirmed</span>
              <span th:if="${reservation.status.name() == 'PENDING'}" class="px-3 py-1 bg-cinema-gold/10 text-cinema-gold text-[10px] font-black rounded-full border border-cinema-gold/20 uppercase tracking-widest">Pending</span>
              <span th:if="${reservation.status.name() == 'CANCELLED'}"
                    class="px-3 py-1 bg-red-500/10 text-red-500 text-[10px] font-black rounded-full border border-red-500/20 uppercase tracking-widest">Cancelled</span>
            </div>
          </div>

          <!-- Actions -->
          <div class="mt-8 space-y-3">
            <a th:if="${reservation.status.name() == 'PENDING'}" th:href="@{/booking/payment/{id}(id=${reservation.id})}"
               class="block w-full bg-cinema-accent hover:bg-cinema-accentHover text-white text-center py-4 rounded-xl font-bold transition shadow-lg shadow-purple-900/30 no-underline uppercase tracking-widest text-xs">
              Complete Secure Payment
            </a>
            <a th:if="${reservation.status.name() == 'PAID'}" th:href="@{/api/v1/reservations/{id}/pdf(id=${reservation.id})}"
               target="_blank"
               class="block w-full bg-white/10 hover:bg-white/20 text-white text-center py-4 rounded-xl font-bold transition shadow-lg no-underline group uppercase tracking-widest text-xs">
              <i class="fas fa-file-pdf mr-2 group-hover:text-red-500 transition"></i> Print E-Tickets
            </a>
            <div th:if="${reservation.status.name() == 'CANCELLED'}"
                 class="text-center p-4 bg-white/5 rounded-xl border border-white/5">
              <p class="text-gray-500 text-xs italic">This reservation has been cancelled and cannot be processed.</p>
            </div>
          </div>
        </div>

        <!-- Ticket Stubs List -->
        <div class="bg-cinema-dark/60 p-8 rounded-3xl border border-white/5 shadow-2xl">
          <h3 class="text-white font-bold mb-6 flex items-center gap-3">
            <span class="w-1.5 h-6 bg-cinema-accent rounded-full"></span>
            Seat Assignments
          </h3>

          <div class="space-y-4">
            <div th:each="ticket : ${reservation.tickets}" class="bg-black/40 p-4 rounded-2xl border border-white/5 flex justify-between items-center group">
              <div class="flex items-center gap-5">
                <div class="text-center">
                  <div class="text-[10px] text-gray-500 uppercase font-black">Row</div>
                  <div class="font-bold text-white text-xl" th:text="${ticket.seat.rowNumber}">1</div>
                </div>
                <div class="text-center">
                  <div class="text-[10px] text-gray-500 uppercase font-black">Seat</div>
                  <div class="font-bold text-cinema-accent text-xl" th:text="${ticket.seat.seatNumber}">5</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-[10px] font-bold text-gray-400 uppercase bg-gray-800 px-2 py-0.5 rounded" th:text="${ticket.ticketType}">STANDARD</div>
                <div th:if="${ticket.ticketCode != null}" class="text-[9px] font-mono text-green-400 mt-2 flex items-center gap-1">
                  <i class="fas fa-barcode"></i> <span th:text="${#strings.substring(ticket.ticketCode, 0, 8)}">CODE</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Interactive Room Preview -->
      <div class="lg:col-span-2">
        <div class="bg-gradient-to-br from-cinema-dark to-black p-10 rounded-3xl border border-white/5 shadow-2xl h-full flex flex-col items-center relative overflow-hidden">

          <div class="absolute top-0 right-0 w-96 h-96 bg-cinema-accent/5 rounded-full blur-[120px] -mr-48 -mt-48"></div>

          <h3 class="text-gray-500 text-[10px] uppercase font-black tracking-[0.3em] mb-12">Theater Orientation</h3>

          <div class="w-full max-w-2xl">
            <!-- Movie Screen -->
            <div class="flex flex-col items-center mb-16 px-10">
              <div class="screen h-2 w-full mb-4"></div>
              <span class="text-[10px] text-gray-700 uppercase tracking-[0.5em] font-bold">Cinema Screen Perspective</span>
            </div>

            <!-- Seat Grid Container -->
            <div id="seat-grid" class="flex flex-col items-center gap-3 mb-12">
              <div class="flex items-center gap-4 text-cinema-accent opacity-50 italic">
                <i class="fas fa-circle-notch animate-spin"></i> Rendering Room Layout...
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div class="mt-auto flex flex-wrap justify-center gap-8 text-[10px] text-gray-500 font-black uppercase tracking-widest border-t border-white/5 pt-8 w-full">
            <div class="flex items-center gap-3"><div class="w-4 h-4 bg-cinema-accent rounded-md shadow-lg shadow-purple-900/40"></div> Your Selection</div>
            <div class="flex items-center gap-3"><div class="w-4 h-4 bg-red-900/40 rounded-md"></div> Occupied Seats</div>
            <div class="flex items-center gap-3"><div class="w-4 h-4 bg-cinema-black border border-gray-700 rounded-md"></div> Available</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    /**
     * Data Extraction from Thymeleaf for API consumption
     */
    const seanceId = /*[[${reservation.tickets.empty ? 0 : reservation.tickets[0].seance.id}]]*/ 0;

    // Process seat logic for the current user
    /*[+
    const mySeatIds = [
        [# th:each="ticket : ${reservation.tickets}"]
            [[${ticket.seat.id}]],
        [/]
    ];
    +]*/
    const safeMySeatIds = (typeof mySeatIds !== 'undefined') ? mySeatIds : [];

    // Success notification handler
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') === 'true') {
        const alertBox = document.getElementById('success-alert');
        if(alertBox) alertBox.classList.remove('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      if(seanceId > 0) fetchSeats();
    });

    /**
     * Fetch room status via REST API
     */
    async function fetchSeats() {
      try {
        const response = await fetch(`/api/v1/seances/${seanceId}/seats`);
        const seats = await response.json();
        renderGrid(seats);
      } catch (e) {
        console.error('Grid load error:', e);
        document.getElementById('seat-grid').innerHTML = '<p class="text-red-500 text-xs">Failed to load interactive map.</p>';
      }
    }

    /**
     * Render UI Seat Grid
     */
    function renderGrid(seats) {
      const grid = document.getElementById('seat-grid');
      grid.innerHTML = '';

      // Regroup seats by rows for structural rendering
      const rows = {};
      seats.forEach(seat => {
        if (!rows[seat.rowNumber]) rows[seat.rowNumber] = [];
        rows[seat.rowNumber].push(seat);
      });

      Object.keys(rows).forEach(rowNum => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'flex gap-2.5 items-center';

        rows[rowNum].forEach(seat => {
          const seatDiv = document.createElement('div');
          let className = 'seat flex items-center justify-center ';

          if (safeMySeatIds.includes(seat.id)) {
            className += 'mine';
            seatDiv.title = "Verified Ticket: Seat " + seat.seatNumber;
          } else if (seat.occupied) {
            className += 'occupied';
          } else {
            className += 'available';
          }

          seatDiv.className = className;
          seatDiv.innerText = seat.seatNumber;
          rowDiv.appendChild(seatDiv);
        });

        grid.appendChild(rowDiv);
      });
    }
  </script>
</div>
</body>
</html>
